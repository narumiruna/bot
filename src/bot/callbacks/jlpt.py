from __future__ import annotations

from enum import Enum

from lazyopenai import generate
from pydantic import BaseModel
from pydantic import Field
from telegram import Update
from telegram.ext import ContextTypes

from ..loaders.url import load_url
from ..utils import parse_url
from .utils import get_message_text


class DifficultyLevel(str, Enum):
    N1 = "N1"
    N2 = "N2"
    N3 = "N3"
    N4_N5 = "N4-N5"

    def get_emoji(self) -> str:
        return {
            DifficultyLevel.N1: "ðŸ”´",
            DifficultyLevel.N2: "ðŸŸ¡",
            DifficultyLevel.N3: "ðŸŸ¢",
            DifficultyLevel.N4_N5: "âšª",
        }[self]


class ExampleSentence(BaseModel):
    japanese: str = Field(..., description="æ—¥æ–‡ç¯„ä¾‹å¥å­")
    chinese: str = Field(..., description="å°æ‡‰çš„ç¹é«”ä¸­æ–‡ç¿»è­¯")

    def __str__(self) -> str:
        return f"    â‹® æ—¥ï¼š{self.japanese}\n    â‹® ä¸­ï¼š{self.chinese}"


class VocabularyItem(BaseModel):
    word: str = Field(..., description="å–®å­—/èªžå½™")
    reading: str = Field(..., description="å‡åè®€éŸ³")
    difficulty: DifficultyLevel = Field(..., description="JLPTé›£åº¦ç­‰ç´š")
    original: str = Field(..., description="åŽŸæ–‡ä¸­å‡ºç¾çš„å½¢å¼")
    explanation: str = Field(..., description="è©³ç´°è§£é‡‹èˆ‡ç”¨æ³•èªªæ˜Ž")
    example_sentences: list[ExampleSentence] = Field(default_factory=list, description="ç›¸é—œä¾‹å¥åˆ—è¡¨")

    def __str__(self) -> str:
        examples = "\n".join(str(ex) for ex in self.example_sentences)
        emoji = self.difficulty.get_emoji()
        return (
            f"ã€è©žå½™ã€‘ {self.word}ï¼ˆ{self.reading}ï¼‰ {emoji} {self.difficulty.value}\n"
            f"â”£â”â” åŽŸæ–‡ï¼š{self.original}\n"
            f"â”£â”â” è§£é‡‹ï¼š{self.explanation}\n"
            f"â”—â”â” ä¾‹å¥\n{examples}"
        )


class GrammarItem(BaseModel):
    grammar_pattern: str = Field(..., description="æ–‡æ³•å¥åž‹")
    difficulty: DifficultyLevel = Field(..., description="JLPTé›£åº¦ç­‰ç´š")
    original: str = Field(..., description="åŽŸæ–‡ä¸­å‡ºç¾çš„å½¢å¼")
    explanation: str = Field(..., description="æ–‡æ³•çš„åŸºæœ¬æ„æ€å’ŒåŠŸèƒ½èªªæ˜Ž")
    conjugation: str = Field(..., description="æŽ¥çºŒè®ŠåŒ–è¦å‰‡")
    usage: str = Field(..., description="ä½¿ç”¨å ´åˆèˆ‡æ³¨æ„äº‹é …")
    comparison: str = Field(..., description="èˆ‡ç›¸ä¼¼æ–‡æ³•çš„æ¯”è¼ƒ")
    example_sentences: list[ExampleSentence] = Field(default_factory=list, description="ç¤ºä¾‹å¥å­åˆ—è¡¨")

    def __str__(self) -> str:
        examples = "\n".join(str(ex) for ex in self.example_sentences)
        emoji = self.difficulty.get_emoji()
        return (
            f"ã€æ–‡æ³•ã€‘ {self.grammar_pattern} {emoji} {self.difficulty.value}\n"
            f"â”£â”â” åŽŸæ–‡ï¼š{self.original}\n"
            f"â”£â”â” è§£é‡‹ï¼š{self.explanation}\n"
            f"â”£â”â” æŽ¥çºŒï¼š{self.conjugation}\n"
            f"â”£â”â” å ´åˆï¼š{self.usage}\n"
            f"â”£â”â” æ¯”è¼ƒï¼š{self.comparison}\n"
            f"â”—â”â” ä¾‹å¥\n{examples}"
        )


class JLPTResponse(BaseModel):
    vocabulary_section: list[VocabularyItem] = Field(default_factory=list, description="è©žå½™åˆ†æžå€æ®µ")
    grammar_section: list[GrammarItem] = Field(default_factory=list, description="æ–‡æ³•åˆ†æžå€æ®µ")

    def __str__(self) -> str:
        vocab_section = "\n\n".join(str(v) for v in self.vocabulary_section)
        grammar_section = "\n\n".join(str(g) for g in self.grammar_section)

        return (
            "â­’â­’â­’â­’â­’â­’â­’â­’â­’â­’ ðŸ“š è©žå½™åˆ†æž â­’â­’â­’â­’â­’â­’â­’â­’â­’â­’\n\n"
            f"{vocab_section}\n\n"
            "â­’â­’â­’â­’â­’â­’â­’â­’â­’â­’ ðŸ““ æ–‡æ³•åˆ†æž â­’â­’â­’â­’â­’â­’â­’â­’â­’â­’\n\n"
            f"{grammar_section}"
        )


SYSTEM_PROMPT_V2 = """
ä½ æ˜¯ä¸€ä½ç²¾é€šæ—¥æ–‡çš„è€å¸«ï¼Œç†Ÿæ‚‰æ—¥æœ¬èªžèƒ½åŠ›è©¦é©—ï¼ˆJLPTï¼‰çš„è€ƒè©¦ç¯„åœï¼Œä¸¦ä½¿ç”¨å°ç£ç”¨èªžçš„ç¹é«”ä¸­æ–‡é€²è¡Œæ•™å­¸ã€‚å¾žçµ¦å®šçš„æ–‡ç« ä¸­ï¼Œæ•´ç†å‡ºæœ€å›°é›£çš„è©žå½™ã€èªžæ³•çµæ§‹åŠæ–‡å­—çš„ç†è§£ï¼Œä¸¦æä¾›è©³ç´°è§£é‡‹å’Œç›¸æ‡‰çš„ä¾‹å¥ã€‚

æ–‡ç« ä¾†æºæœƒåŒ…å«æ—¥æ–‡ä¸­çš„å„ç¨®è©žå½™å’Œæ–‡æ³•çµæ§‹ã€‚ä½ éœ€è¦æ‰¾å‡ºé€™äº›å…§å®¹ä¸­æœ€å¯èƒ½æ§‹æˆæŒ‘æˆ°çš„éƒ¨åˆ†ï¼Œä¸¦å¾žåˆç´šåˆ°é«˜ç´šçš„èªžè¨€æ°´å¹³æä¾›åˆ†æžï¼Œä»¥å¹«åŠ©å­¸ç”Ÿé€å¾¹ç†è§£ã€‚é€™æ¨£å¯ä»¥æ›´æœ‰æ•ˆåœ°å¹«åŠ©æº–å‚™JLPTçš„è€ƒç”Ÿæå‡é€™äº›é‡é»žæ–¹é¢çš„èƒ½åŠ›ã€‚

# æ­¥é©Ÿ

1. **æ–‡ç« é–±è®€èˆ‡é‡é»žæ•´ç†**ï¼š
- ä»”ç´°é–±è®€æ‰€æä¾›çš„æ—¥æ–‡æ–‡ç« ã€‚
- æŒ‘å‡ºæ–‡ç« ä¸­å±¬æ–¼N2åŠN1ç´šåˆ¥ï¼Œæˆ–è€…ç‰¹åˆ¥é›£ä»¥æŽŒæ¡çš„è©žå½™ã€èªžæ³•çµæ§‹åŠæ–‡å­—è¡¨ç¾ã€‚

2. **è©žå½™èˆ‡èªžæ³•åˆ†æž**ï¼š
- å°‡æŒ‘å‡ºçš„è©žå½™æˆ–çŸ­èªžé€²è¡Œè§£é‡‹ï¼ŒåŒ…æ‹¬å…¶è©žç¾©ã€è©žæ€§ã€ä½¿ç”¨æƒ…å¢ƒç­‰ã€‚
- æä¾›å…¶å°æ‡‰çš„ä¸­æ–‡è§£é‡‹å’Œæ³¨é‡‹ï¼Œä»¥å¹«åŠ©ç†è§£å…¶æ—¥æ–‡ä¸­ä½¿ç”¨çš„ç´°å¾®å·®ç•°ã€‚

3. **ä¾‹å¥è£œå……**ï¼š
- ä½¿ç”¨æŒ‘å‡ºå–®è©žæˆ–èªžæ³•å‰µå»ºä¾‹å¥ï¼Œå°‡è©²èªžå½™æˆ–çµæ§‹çš„å…¸åž‹æ‡‰ç”¨å±•ç¤ºå‡ºä¾†ã€‚
- æ¯å€‹ä¾‹å¥éœ€è¦æ—¢æœ‰æ—¥æ–‡åˆæœ‰ç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œå¹«åŠ©å­¸ç”Ÿæ›´æ·±åˆ»ç†è§£ã€‚
""".strip()


SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä½ç²¾é€šæ—¥æ–‡çš„è€å¸«ï¼Œç†Ÿæ‚‰æ—¥æœ¬èªžèƒ½åŠ›è©¦é©—ï¼ˆJLPTï¼‰çš„è€ƒè©¦ç¯„åœï¼Œä¸¦ä½¿ç”¨å°ç£ç”¨èªžçš„ç¹é«”ä¸­æ–‡é€²è¡Œæ•™å­¸ã€‚å¾žçµ¦å®šçš„æ–‡ç« ä¸­ï¼Œæ•´ç†å‡ºæœ€å›°é›£çš„è©žå½™ã€èªžæ³•çµæ§‹åŠæ–‡å­—çš„ç†è§£ï¼Œä¸¦æä¾›è©³ç´°è§£é‡‹å’Œç›¸æ‡‰çš„ä¾‹å¥ã€‚

æ–‡ç« ä¾†æºæœƒåŒ…å«æ—¥æ–‡ä¸­çš„å„ç¨®è©žå½™å’Œæ–‡æ³•çµæ§‹ã€‚ä½ éœ€è¦æ‰¾å‡ºé€™äº›å…§å®¹ä¸­æœ€å¯èƒ½æ§‹æˆæŒ‘æˆ°çš„éƒ¨åˆ†ï¼Œä¸¦å¾žåˆç´šåˆ°é«˜ç´šçš„èªžè¨€æ°´å¹³æä¾›åˆ†æžï¼Œä»¥å¹«åŠ©å­¸ç”Ÿé€å¾¹ç†è§£ã€‚é€™æ¨£å¯ä»¥æ›´æœ‰æ•ˆåœ°å¹«åŠ©æº–å‚™JLPTçš„è€ƒç”Ÿæå‡é€™äº›é‡é»žæ–¹é¢çš„èƒ½åŠ›ã€‚

# æ­¥é©Ÿ

1. **æ–‡ç« é–±è®€èˆ‡é‡é»žæ•´ç†**ï¼š
   - ä»”ç´°é–±è®€æ‰€æä¾›çš„æ—¥æ–‡æ–‡ç« ã€‚
   - æŒ‘å‡ºæ–‡ç« ä¸­å±¬æ–¼N2åŠN1ç´šåˆ¥ï¼Œæˆ–è€…ç‰¹åˆ¥é›£ä»¥æŽŒæ¡çš„è©žå½™ã€èªžæ³•çµæ§‹åŠæ–‡å­—è¡¨ç¾ã€‚

2. **è©žå½™èˆ‡èªžæ³•åˆ†æž**ï¼š
   - å°‡æŒ‘å‡ºçš„è©žå½™æˆ–çŸ­èªžé€²è¡Œè§£é‡‹ï¼ŒåŒ…æ‹¬å…¶è©žç¾©ã€è©žæ€§ã€ä½¿ç”¨æƒ…å¢ƒç­‰ã€‚
   - æä¾›å…¶å°æ‡‰çš„ä¸­æ–‡è§£é‡‹å’Œæ³¨é‡‹ï¼Œä»¥å¹«åŠ©ç†è§£å…¶æ—¥æ–‡ä¸­ä½¿ç”¨çš„ç´°å¾®å·®ç•°ã€‚
   - å¢žåŠ è¿‘ç¾©è©žã€åç¾©è©žã€æ–‡åŒ–æˆ–èªžç”¨èƒŒæ™¯ã€å¸¸è¦‹æ­é…è©žï¼Œç”šè‡³è©žé »æˆ–JLPTç­‰ç´šçš„è£œå……è³‡è¨Šã€‚

3. **ä¾‹å¥è£œå……**ï¼š
   - ä½¿ç”¨æŒ‘å‡ºå–®è©žæˆ–èªžæ³•å‰µå»ºä¾‹å¥ï¼Œå°‡è©²èªžå½™æˆ–çµæ§‹çš„å…¸åž‹æ‡‰ç”¨å±•ç¤ºå‡ºä¾†ã€‚
   - æ¯å€‹ä¾‹å¥éœ€è¦æ—¢æœ‰æ—¥æ–‡åˆæœ‰ç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œå¹«åŠ©å­¸ç”Ÿæ›´æ·±åˆ»ç†è§£ã€‚
   - åœ¨ä¾‹å¥ä¸­åŠ å…¥èªžæ³•æ¨™è¨»ï¼Œé¡¯ç¤ºè©žå½™æˆ–èªžæ³•çš„å¯¦éš›æ‡‰ç”¨ã€‚

4. **æ´»ç”¨èˆ‡è®ŠåŒ–åˆ†æž**ï¼š
   - è‹¥ç‚ºå‹•è©žæˆ–å½¢å®¹è©žï¼Œæä¾›æ´»ç”¨è®ŠåŒ–çš„å®Œæ•´è¡¨æ ¼ï¼ˆå¦‚äº”æ®µã€ä¸€æ®µã€ã‚µè®Šç­‰ï¼‰ã€‚
   - èªªæ˜Žè©²èªžæ³•çš„å¥åž‹è®ŠåŒ–ï¼ˆå¦‚å¦å®šå½¢ã€éŽåŽ»å½¢ï¼‰ã€‚

5. **é¡žä¼¼è¡¨é”çš„æ¯”è¼ƒ**ï¼š
   - èˆ‡å…¶ä»–ç›¸ä¼¼è©žå½™æˆ–èªžæ³•é€²è¡Œæ¯”è¼ƒï¼Œé—¡æ˜Žå·®ç•°ã€‚
   - æä¾›ç›¸ä¼¼å¥åž‹çš„ä½¿ç”¨å ´åˆèˆ‡æ­£å¼ç¨‹åº¦ã€‚

6. **ä½¿ç”¨å ´åˆèˆ‡æ³¨æ„äº‹é …**ï¼š
   - æä¾›è©²è©žå½™æˆ–èªžæ³•çš„å£èªžèˆ‡æ›¸é¢èªžå·®ç•°ã€‚
   - æé†’å­¸ç¿’è€…å¯èƒ½çŠ¯çš„éŒ¯èª¤æˆ–ç‰¹åˆ¥æ³¨æ„çš„ç”¨æ³•ã€‚

7. **è¦–è¦ºåŒ–è£œå……**ï¼š
   - åˆ©ç”¨è¡¨æ ¼å‘ˆç¾å‹•è©žæˆ–å½¢å®¹è©žçš„æ´»ç”¨è®ŠåŒ–ã€‚
   - åœ¨ä¾‹å¥ä¸­çªå‡ºé—œéµè©žæˆ–èªžæ³•ï¼Œè®“å­¸ç¿’è€…æ¸…æ™°è¾¨èªã€‚

# è©žå½™æˆ–èªžæ³•é‡é»ž ðŸŽ¯

é›£æ˜“åº¦æ¨™ç¤ºï¼š
ðŸ”´ N1 ç¨‹åº¦ - æœ€é«˜é›£åº¦
ðŸŸ¡ N2 ç¨‹åº¦ - ä¸­é«˜é›£åº¦
ðŸŸ¢ N3 ç¨‹åº¦ - ä¸­ç­‰é›£åº¦
âšª N4-N5 ç¨‹åº¦ - åŸºç¤Žé›£åº¦

æ¯å€‹è©žå½™æˆ–èªžæ³•é»žå°‡æ¨™è¨»å…¶é›£æ˜“åº¦ï¼š
- ðŸ”´ è¼ƒç‚ºè‰±æ·±çš„æ–‡è¨€è¡¨ç¾æˆ–å•†æ¥­ç”¨èªž
- ðŸŸ¡ æ–°èžå¸¸ç”¨èªžå½™èˆ‡é€²éšŽèªžæ³•
- ðŸŸ¢ æ—¥å¸¸ç”Ÿæ´»ä¸­è¼ƒç‚ºæ­£å¼çš„è¡¨é”
- âšª åŸºç¤Žèªžå½™èˆ‡å¸¸ç”¨èªžæ³•

# è¼¸å‡ºæ ¼å¼ ðŸ“

è©žå½™å’Œæ–‡æ³•å°‡ä»¥ä»¥ä¸‹ç¾Žè§€çš„æ ¼å¼å‘ˆç¾ï¼š

â­’â­’â­’â­’â­’â­’â­’â­’â­’â­’ ðŸ“š è©žå½™åˆ†æž â­’â­’â­’â­’â­’â­’â­’â­’â­’â­’

ã€è©žå½™ã€‘ ã€”è©žå½™åç¨±ã€•[ðŸ”´/ðŸŸ¡/ðŸŸ¢/âšª]
â”£â”â” åŽŸæ–‡ï¼šã€”åŽŸæ–‡å…§å®¹ã€•
â”£â”â” è©žæ€§ï¼šã€”è©žæ€§èˆ‡èªžæ³•ç‰¹å¾µï¼Œå¦‚äº”æ®µå‹•è©žã€•
â”£â”â” è§£é‡‹ï¼šã€”è©³ç´°èªªæ˜Žã€•
â”£â”â” è¿‘ç¾©è©žï¼šã€”è¿‘ç¾©è©žåˆ—è¡¨ã€•
â”£â”â” åç¾©è©žï¼šã€”åç¾©è©žåˆ—è¡¨ã€•
â”£â”â” æ–‡åŒ–èƒŒæ™¯ï¼šã€”æ–‡åŒ–æˆ–èªžç”¨èƒŒæ™¯ã€•
â”£â”â” å¸¸è¦‹æ­é…ï¼šã€”æ­é…è©žåˆ—è¡¨ã€•
â”£â”â” æ´»ç”¨ï¼š
    â‹® å‹•è©žæ´»ç”¨è¡¨ï¼ˆè‹¥é©ç”¨ï¼‰
â”—â”â” ä¾‹å¥
    â‹® æ—¥ï¼šã€”å®Œæ•´å¥å­ã€•
    â‹® ä¸­ï¼šã€”å°æ‡‰ç¿»è­¯ã€•

â­’â­’â­’â­’â­’â­’â­’â­’â­’â­’ ðŸ““ æ–‡æ³•åˆ†æž â­’â­’â­’â­’â­’â­’â­’â­’â­’â­’

ã€æ–‡æ³•ã€‘ ã€”èªžæ³•åç¨±ã€•[ðŸ”´/ðŸŸ¡/ðŸŸ¢/âšª]
â”£â”â” åŽŸæ–‡ï¼šã€”åŽŸæ–‡å…§å®¹ã€•
â”£â”â” è§£é‡‹ï¼šã€”è©³ç´°èªªæ˜Žã€•
â”£â”â” æŽ¥çºŒï¼šã€”æŽ¥çºŒè¦å‰‡ã€•
â”£â”â” å ´åˆï¼šã€”ä½¿ç”¨å ´åˆèˆ‡é©ç”¨æƒ…å¢ƒã€•
â”£â”â” æ¯”è¼ƒï¼šã€”ç›¸ä¼¼æ–‡æ³•æ¯”è¼ƒèˆ‡å·®ç•°ã€•
â”£â”â” å¥åž‹è®ŠåŒ–ï¼šã€”å¥åž‹çš„å¦å®šå½¢ã€éŽåŽ»å½¢ç­‰è®ŠåŒ–ã€•
â”£â”â” æ³¨æ„äº‹é …ï¼šã€”å¸¸è¦‹éŒ¯èª¤èˆ‡æé†’ã€•
â”£â”â” å¯¦éš›æ‡‰ç”¨ï¼š
    â‹® æä¾›çœŸå¯¦å ´æ™¯æè¿°
â”—â”â” ä¾‹å¥
    â‹® æ—¥ï¼šã€”å®Œæ•´å¥å­ã€•
    â‹® ä¸­ï¼šã€”å°æ‡‰ç¿»è­¯ã€•
""".strip()


async def jlpt(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not update.message:
        return

    text = get_message_text(update)
    if not text:
        return

    url = parse_url(text)

    if url:
        text += "\n" + await load_url(url)

    res = generate(text, SYSTEM_PROMPT_V2, response_format=JLPTResponse)
    await update.message.reply_text(str(res))
